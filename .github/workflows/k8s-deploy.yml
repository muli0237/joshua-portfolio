name: Kubernetes Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'k8s/**'
      - '.github/workflows/k8s-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    - name: Validate Kubernetes manifests
      run: |
        kubectl apply -f k8s/ --dry-run=client -o yaml

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/rbac.yaml
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/hpa.yaml
        kubectl apply -f k8s/pdb.yaml
        kubectl apply -f k8s/networkpolicy.yaml
        kubectl apply -f k8s/ingress.yaml

    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/joshua-portfolio-app \
          -n joshua-portfolio \
          --timeout=5m

    - name: Verify deployment
      run: |
        kubectl get pods -n joshua-portfolio
        kubectl get svc -n joshua-portfolio
        kubectl get ingress -n joshua-portfolio

    - name: Check pod logs
      if: failure()
      run: |
        kubectl logs -n joshua-portfolio \
          -l app=joshua-portfolio \
          --tail=50

    - name: Slack notification
      if: always()
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "Kubernetes deployment ${{ job.status }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Kubernetes Deployment*\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

